name: Build and Deploy Docker Images
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'storefront/**'
      - '.github/workflows/**'

concurrency:
  group: ${{ github.ref }}/build-deploy
  cancel-in-progress: true

jobs:
  backend:
    runs-on: ubuntu-22.04
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check backend changes
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^backend/'; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.changes.outputs.backend == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: steps.changes.outputs.backend == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        if: steps.changes.outputs.backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-backend:buildcache,mode=max

  storefront:
    runs-on: ubuntu-22.04
    needs: backend
    outputs:
      storefront_changed: ${{ steps.changes.outputs.storefront }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check storefront changes
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^storefront/'; then
            echo "storefront=true" >> $GITHUB_OUTPUT
          else
            echo "storefront=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout backend for compose files
        if: steps.changes.outputs.storefront == 'true'
        uses: actions/checkout@v4
        with:
          path: medusa-starter-default

      - name: Start backend
        if: steps.changes.outputs.storefront == 'true'
        run: |
          cd medusa-starter-default
          docker compose -f compose.yaml up --build -d
          
      - name: Wait for backend to be healthy
        if: steps.changes.outputs.storefront == 'true'
        run: |
          cd medusa-starter-default
          timeout 300 bash -c 'until docker compose ps | grep backend-server | grep -q "healthy"; do sleep 5; done'

      - name: Seed backend with data
        if: steps.changes.outputs.storefront == 'true'
        run: |
          cd medusa-starter-default
          docker compose -f compose.seed.yaml run --rm seed

      - name: Set up Docker Buildx
        if: steps.changes.outputs.storefront == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: steps.changes.outputs.storefront == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push storefront
        if: steps.changes.outputs.storefront == 'true'
        uses: docker/build-push-action@v5
        with:
          context: storefront
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-storefront:latest
          network: host
          build-args: |
            NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY=${{ secrets.MEDUSA_PUBLISHABLE_KEY }}
            MEDUSA_BACKEND_URL=http://localhost:9000
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-storefront:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-storefront:buildcache,mode=max

  deploy:
    runs-on: ubuntu-22.04
    needs: [backend, storefront]
    if: needs.backend.outputs.backend_changed == 'true' || needs.storefront.outputs.storefront_changed == 'true'
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Pull latest images
            if [ "${{ needs.backend.outputs.backend_changed }}" == "true" ]; then
              echo "Pulling backend image..."
              docker pull ${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-backend:latest
              
              echo "Restarting backend..."
              docker compose -f compose.yaml down backend-server
              docker compose -f compose.yaml up -d backend-server
              
              # Wait for backend to be healthy
              timeout 300 bash -c 'until docker compose ps | grep backend-server | grep -q "healthy"; do sleep 5; done'
            fi
            
            if [ "${{ needs.storefront.outputs.storefront_changed }}" == "true" ]; then
              echo "Pulling storefront image..."
              docker pull ${{ secrets.DOCKERHUB_USERNAME }}/art-medusa-storefront:latest
              
              echo "Restarting storefront..."
              docker compose -f compose.storefront.yaml down frontend
              docker compose -f compose.storefront.yaml up -d frontend
              
              # Wait for frontend to be ready
              sleep 10
              timeout 60 bash -c 'until curl -f http://localhost:8000 > /dev/null 2>&1; do sleep 5; done'
            fi
            
            echo "Cleaning up old images..."
            docker image prune -f
            
            echo "Deployment completed!"